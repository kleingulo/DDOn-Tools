[gd_scene load_steps=18 format=3 uid="uid://c7qcqakji48gm"]

[ext_resource type="PackedScene" uid="uid://c7a10g3pejiuy" path="res://UI/EnemyDetailsPanel.tscn" id="1"]
[ext_resource type="Script" path="res://UI/NotificationPopup.gd" id="2"]
[ext_resource type="Script" path="res://UI/DetailsPanel.gd" id="3"]
[ext_resource type="Script" path="res://UI/EnemyFileMenu.gd" id="4"]
[ext_resource type="Script" path="res://UI/UI Buttons/Minimize.gd" id="5"]
[ext_resource type="Script" path="res://UI/EnemyTree.gd" id="6"]
[ext_resource type="PackedScene" path="res://UI/ItemDetailsPanel.tscn" id="7"]
[ext_resource type="PackedScene" uid="uid://ctyhqqwexg434" path="res://UI/Settings.tscn" id="8"]
[ext_resource type="PackedScene" path="res://UI/Chat.tscn" id="9"]
[ext_resource type="Script" path="res://UI/Stages.gd" id="10"]
[ext_resource type="Script" path="res://UI/Players.gd" id="11"]
[ext_resource type="Script" path="res://UI/ItemTree.gd" id="12"]
[ext_resource type="Script" path="res://UI/ItemFileMenu.gd" id="13"]
[ext_resource type="Texture2D" uid="uid://bbrlwa7er4uqs" path="res://resources/icons/brightmixIconset search.png" id="14"]

[sub_resource type="GDScript" id="2"]
script/source = "extends CanvasLayer

signal stage_selected(stage_no)
signal player_activated(player_marker)

@onready var stage_label: Label = $status_view/container/StageLabel
@onready var coordinates_label: Label = $status_view/container/CoordinatesLabel

func _input(event):
	if event is InputEventMouseMotion:
		var mouse_pos : Vector2 = $\"../MapCoordinateSpace\".get_local_mouse_position();
		coordinates_label.text = str(mouse_pos.round())

func _on_Stages_item_selected(index: int) -> void:
	var stage_no = $left/tab/Stages.get_item_metadata(index)
	emit_signal(\"stage_selected\", stage_no)
	
	var stage_id = DataProvider.stage_no_to_stage_id(int(stage_no))
	if stage_id == -1:
		stage_label.text = \"Stage No. \" + stage_no
	else:
		stage_label.text = \"%s (ID: %s, Stage No. %s)\" % [tr(str(\"STAGE_NAME_\",stage_id)), stage_id, stage_no]
	
func _on_Players_item_activated():
	var player: PlayerMapEntity = $left/tab/Players.get_selected().get_metadata(0)
	emit_signal(\"player_activated\", player)

func _on_root_markers_loaded():
	$left/tab/Enemies/FileMenu._on_markers_loaded()

"

[sub_resource type="GDScript" id="3"]
script/source = "extends Button

func _on_SettingsButton_pressed():
	$\"../../../SettingsWindowDialog\".popup_centered()
"

[sub_resource type="GDScript" id="1"]
script/source = "extends PanelContainer

#GD4 migration - anchor_bottom = 0 moves the whole element up so it will overlap with the status_view
#there is most likely a better solution for this - for example cleaning up the layout - but meh...
var minimized = false:
	set(value):
		if value == true:
			anchor_bottom = 0.09
		if value == false:
			anchor_bottom = 1
		#otherwise the scrollbar will be visible
		get_child(0).get_child(1).visible = !value
		minimized = value

func _ready():
	visible = false

func _on_Close_pressed():
	visible = false
	
func _on_DetailsPanel_showing_details_of(obj):
	visible = obj != null
"

[node name="root" type="CanvasLayer"]
script = SubResource("2")

[node name="left" type="PanelContainer" parent="."]
anchors_preset = -1
anchor_top = 0.05
anchor_right = 0.25
anchor_bottom = 1.0
offset_right = 0.496002
grow_horizontal = 2

[node name="tab" type="TabContainer" parent="left"]
layout_mode = 2

[node name="Stages" type="ItemList" parent="left/tab"]
layout_mode = 2
script = ExtResource("10")

[node name="Enemies" type="VBoxContainer" parent="left/tab"]
visible = false
layout_mode = 2

[node name="HBoxContainer" type="HBoxContainer" parent="left/tab/Enemies"]
layout_mode = 2

[node name="EnemyFileMenu" type="MenuButton" parent="left/tab/Enemies/HBoxContainer"]
process_priority = 1
layout_mode = 2
size_flags_horizontal = 0
focus_mode = 2
text = "File"
flat = false
script = ExtResource("4")
enemy_tree = NodePath("../../EnemyTree")
item_tree = NodePath("../../../Items/ItemTree")
file_dialog = NodePath("../../../../../EnemyFileDialog")
notification_popup = NodePath("../../../../../NotificationPopup")

[node name="FilterLineEdit" type="LineEdit" parent="left/tab/Enemies/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 3
right_icon = ExtResource("14")

[node name="EnemyTree" type="Tree" parent="left/tab/Enemies"]
layout_mode = 2
size_flags_vertical = 3
mouse_filter = 1
allow_reselect = true
script = ExtResource("6")

[node name="Items" type="VBoxContainer" parent="left/tab"]
visible = false
layout_mode = 2

[node name="HBoxContainer" type="HBoxContainer" parent="left/tab/Items"]
layout_mode = 2

[node name="ItemFileMenu" type="MenuButton" parent="left/tab/Items/HBoxContainer"]
process_priority = 1
layout_mode = 2
size_flags_horizontal = 0
focus_mode = 2
text = "File"
flat = false
script = ExtResource("13")
item_tree = NodePath("../../ItemTree")
file_dialog = NodePath("../../../../../ItemFileDialog")
notification_popup = NodePath("../../../../../NotificationPopup")

[node name="FilterLineEdit" type="LineEdit" parent="left/tab/Items/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 3
right_icon = ExtResource("14")

[node name="ItemTree" type="Tree" parent="left/tab/Items"]
layout_mode = 2
size_flags_vertical = 3
mouse_filter = 1
allow_reselect = true
script = ExtResource("12")

[node name="Players" type="Tree" parent="left/tab"]
visible = false
layout_mode = 2
hide_root = true
script = ExtResource("11")

[node name="RPCTimer" type="Timer" parent="left/tab/Players"]
wait_time = 5.0
autostart = true

[node name="Chat" parent="left/tab" instance=ExtResource("9")]
visible = false
layout_mode = 2

[node name="status_view" type="PanelContainer" parent="."]
anchors_preset = 10
anchor_right = 1.0
offset_bottom = 32.0
grow_horizontal = 2

[node name="container" type="HBoxContainer" parent="status_view"]
layout_mode = 2

[node name="minimize" type="Button" parent="status_view/container"]
layout_mode = 2
text = "-"
script = ExtResource("5")
control_to_minimize = NodePath("../../../left")
property_to_toggle = "visible"

[node name="LayerOptionButton" type="OptionButton" parent="status_view/container"]
layout_mode = 2
item_count = 10
popup/item_0/text = "Layer 0"
popup/item_0/id = 0
popup/item_1/text = "Layer 1"
popup/item_1/id = 1
popup/item_2/text = "Layer 2"
popup/item_2/id = 2
popup/item_3/text = "Layer 3"
popup/item_3/id = 3
popup/item_4/text = "Layer 4"
popup/item_4/id = 4
popup/item_5/text = "Layer 5"
popup/item_5/id = 5
popup/item_6/text = "Layer 6"
popup/item_6/id = 6
popup/item_7/text = "Layer 7"
popup/item_7/id = 7
popup/item_8/text = "Layer 8"
popup/item_8/id = 8
popup/item_9/text = "Layer 9"
popup/item_9/id = 9

[node name="StageLabel" type="Label" parent="status_view/container"]
layout_mode = 2
text = "Stage Name (ID and Number)"

[node name="Spacer" type="Control" parent="status_view/container"]
layout_mode = 2
size_flags_horizontal = 3

[node name="CoordinatesLabel" type="Label" parent="status_view/container"]
layout_mode = 2
text = "Coordinates"

[node name="SettingsButton" type="Button" parent="status_view/container"]
layout_mode = 2
text = "Settings"
script = SubResource("3")

[node name="Right Panel" type="PanelContainer" parent="."]
anchors_preset = -1
anchor_left = 0.55
anchor_top = 0.05
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 0
size_flags_horizontal = 3
size_flags_vertical = 3
script = SubResource("1")
metadata/_edit_use_anchors_ = true

[node name="VBoxContainer" type="VBoxContainer" parent="Right Panel"]
layout_mode = 2

[node name="HBoxContainer" type="HBoxContainer" parent="Right Panel/VBoxContainer"]
layout_mode = 2

[node name="TitleLabel" type="Label" parent="Right Panel/VBoxContainer/HBoxContainer"]
layout_mode = 2
text = "Placeholder Title"

[node name="Control" type="Control" parent="Right Panel/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3

[node name="Minimize" type="Button" parent="Right Panel/VBoxContainer/HBoxContainer"]
layout_mode = 2
text = "-"
script = ExtResource("5")
control_to_minimize = NodePath("../../..")
property_to_toggle = "minimized"

[node name="Close" type="Button" parent="Right Panel/VBoxContainer/HBoxContainer"]
layout_mode = 2
text = "X"

[node name="DetailsPanel" type="Panel" parent="Right Panel/VBoxContainer" groups=["DetailsPanel"]]
layout_mode = 2
size_flags_vertical = 3
script = ExtResource("3")

[node name="EnemyDetailsPanel" parent="Right Panel/VBoxContainer/DetailsPanel" instance=ExtResource("1")]
layout_mode = 1
offset_left = 0.0
offset_top = 0.0
offset_right = 0.0
offset_bottom = 0.0
grow_horizontal = 2
grow_vertical = 2
title_label = NodePath("../../HBoxContainer/TitleLabel")

[node name="ItemDetailsPanel" parent="Right Panel/VBoxContainer/DetailsPanel" instance=ExtResource("7")]
layout_mode = 1
anchors_preset = 15
offset_left = 0.0
offset_top = 0.0
offset_right = 0.0
offset_bottom = 0.0
grow_horizontal = 2
grow_vertical = 2
title_label = NodePath("../../HBoxContainer/TitleLabel")

[node name="NotificationPopup" type="PopupPanel" parent="."]
script = ExtResource("2")

[node name="Label" type="Label" parent="NotificationPopup"]
offset_left = 4.0
offset_top = 4.0
offset_right = 96.0
offset_bottom = 96.0
text = "Notification"

[node name="SettingsWindowDialog" parent="." instance=ExtResource("8")]

[node name="EnemyFileDialog" type="FileDialog" parent="."]
access = 2
filters = PackedStringArray("*.json; JSON Files", "*.csv ; CSV Files")
show_hidden_files = true

[node name="ItemFileDialog" type="FileDialog" parent="."]
access = 2
filters = PackedStringArray("*.csv ; CSV Files")
show_hidden_files = true

[connection signal="item_selected" from="left/tab/Stages" to="." method="_on_Stages_item_selected"]
[connection signal="text_changed" from="left/tab/Enemies/HBoxContainer/FilterLineEdit" to="left/tab/Enemies/EnemyTree" method="_on_FilterLineEdit_text_changed"]
[connection signal="text_changed" from="left/tab/Items/HBoxContainer/FilterLineEdit" to="left/tab/Items/ItemTree" method="_on_FilterLineEdit_text_changed"]
[connection signal="item_activated" from="left/tab/Players" to="." method="_on_Players_item_activated"]
[connection signal="timeout" from="left/tab/Players/RPCTimer" to="left/tab/Players" method="_on_rpc_timer_timeout"]
[connection signal="pressed" from="status_view/container/SettingsButton" to="status_view/container/SettingsButton" method="_on_SettingsButton_pressed"]
[connection signal="pressed" from="Right Panel/VBoxContainer/HBoxContainer/Close" to="Right Panel" method="_on_Close_pressed"]
[connection signal="showing_details_of" from="Right Panel/VBoxContainer/DetailsPanel" to="Right Panel" method="_on_DetailsPanel_showing_details_of"]
